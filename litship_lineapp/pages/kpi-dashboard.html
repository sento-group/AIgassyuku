<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPIç®¡ç† & å£²ä¸Šäºˆæ¸¬ - ç®¡ç†å´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-back {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            display: inline-block;
            text-decoration: none;
        }
        .btn-back:hover {
            background: #218838;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .tab.active {
            background: #00A0B0;
            color: white;
        }
        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        .section.active {
            display: block;
        }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: linear-gradient(135deg, #1A3A52 0%, #00A0B0 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .kpi-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .kpi-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .kpi-trend {
            font-size: 14px;
            opacity: 0.8;
        }
        .submission-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
        }
        .submission-table th,
        .submission-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .submission-table th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        .submission-table tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .status-submitted {
            background: #d4edda;
            color: #155724;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }
        .forecast-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        @media (max-width: 768px) {
            .forecast-section {
                grid-template-columns: 1fr;
            }
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #1A3A52;
            color: white;
        }
        .btn-primary:hover {
            background: #00A0B0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 160, 176, 0.4);
        }
        .formula-box {
            margin-top: 20px;
            padding: 20px;
            background: #e7f3ff;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="btn-back" onclick="location.href='dashboard.html'">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</button>

        <div class="header">
            <h1>ğŸ“Š KPIç®¡ç† & å£²ä¸Šäºˆæ¸¬ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p>äº‹æ¥­è¨ˆç”»ã‹ã‚‰é€†ç®—ã—ãŸKPIç®¡ç†ã¨æ¥æœˆã®å£²ä¸Šäºˆæ¸¬</p>
        </div>

        <!-- ã‚¿ãƒ– -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('kpi')">ğŸ“ˆ KPIæ¦‚è¦</button>
            <button class="tab" onclick="showTab('submission')">ğŸ“… æå‡ºçŠ¶æ³</button>
            <button class="tab" onclick="showTab('forecast')">ğŸ’° å£²ä¸Šäºˆæ¸¬</button>
            <button class="tab" onclick="showTab('plan')">ğŸ¯ äº‹æ¥­è¨ˆç”»</button>
        </div>

        <!-- KPIæ¦‚è¦ -->
        <div id="tab-kpi" class="section active">
            <h2>ğŸ“ˆ ä»Šæœˆã®KPIæ¦‚è¦</h2>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">ä»Šæœˆç›®æ¨™å£²ä¸Š</div>
                    <div class="kpi-value" id="targetSales">Â¥5,000,000</div>
                    <div class="kpi-trend">äº‹æ¥­è¨ˆç”»ãƒ™ãƒ¼ã‚¹</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">äºˆæ¸¬å£²ä¸Š</div>
                    <div class="kpi-value" id="forecastSales">Â¥0</div>
                    <div class="kpi-trend">é”æˆç‡: <span id="achievementRate">0%</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">ç¨¼åƒå¯èƒ½äººæ•°</div>
                    <div class="kpi-value" id="availableStaff">0äºº</div>
                    <div class="kpi-trend">æå‡ºæ¸ˆã¿: <span id="submittedStaff">0</span>/100äºº</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">å»¶ã¹ç¨¼åƒæ—¥æ•°</div>
                    <div class="kpi-value" id="workingDays">0æ—¥</div>
                    <div class="kpi-trend">å…¨ã‚¹ã‚¿ãƒƒãƒ•åˆè¨ˆ</div>
                </div>
            </div>

            <div class="alert-info">
                <strong>ğŸ’¡ KPIã®è¨ˆç®—ã«ã¤ã„ã¦</strong>
                <p>äºˆæ¸¬å£²ä¸Š = å¹³å‡å˜ä¾¡ Ã— å»¶ã¹ç¨¼åƒæ—¥æ•° Ã— ãƒãƒƒãƒãƒ³ã‚°ç‡ã§è¨ˆç®—ã•ã‚Œã¾ã™ã€‚</p>
                <p>ã€Œå£²ä¸Šäºˆæ¸¬ã€ã‚¿ãƒ–ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã§ãã¾ã™ã€‚</p>
            </div>
        </div>

        <!-- æå‡ºçŠ¶æ³ -->
        <div id="tab-submission" class="section">
            <h2>ğŸ“… ç¨¼åƒå¯èƒ½æ—¥æå‡ºçŠ¶æ³</h2>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">æå‡ºæ¸ˆã¿</div>
                    <div class="kpi-value" id="submittedCount">0äºº</div>
                    <div class="kpi-trend"><span id="submittedPercentage">0</span>%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æœªæå‡º</div>
                    <div class="kpi-value" id="pendingCount">100äºº</div>
                    <div class="kpi-trend"><span id="pendingPercentage">100</span>%</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">æœŸé™ã¾ã§</div>
                    <div class="kpi-value" id="daysUntilDeadline">0æ—¥</div>
                    <div class="kpi-trend">æ¯æœˆ15æ—¥ç· åˆ‡</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">å¹³å‡ç¨¼åƒæ—¥æ•°</div>
                    <div class="kpi-value" id="avgDays">0æ—¥</div>
                    <div class="kpi-trend">1äººã‚ãŸã‚Š</div>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table class="submission-table" id="submissionTable">
                    <thead>
                        <tr>
                            <th>ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ‰</th>
                            <th>æ°å</th>
                            <th>å¯¾è±¡æœˆ</th>
                            <th>ç¨¼åƒå¯èƒ½æ—¥æ•°</th>
                            <th>æå‡ºæ—¥æ™‚</th>
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        </tr>
                    </thead>
                    <tbody id="submissionTableBody">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å£²ä¸Šäºˆæ¸¬ -->
        <div id="tab-forecast" class="section">
            <h2>ğŸ’° æ¥æœˆã®å£²ä¸Šäºˆæ¸¬</h2>
            
            <div class="forecast-section">
                <div>
                    <h3>ğŸ“Š äºˆæ¸¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                    <div class="input-group">
                        <label>å¹³å‡å˜ä¾¡ï¼ˆå††/æ—¥ï¼‰</label>
                        <input type="number" id="avgUnitPrice" value="15000" oninput="calculateForecast()">
                    </div>
                    <div class="input-group">
                        <label>ç¨¼åƒå¯èƒ½ã‚¹ã‚¿ãƒƒãƒ•æ•°</label>
                        <input type="number" id="availableStaffCount" value="0" readonly>
                    </div>
                    <div class="input-group">
                        <label>å»¶ã¹ç¨¼åƒæ—¥æ•°</label>
                        <input type="number" id="totalAvailableDays" value="0" readonly>
                    </div>
                    <div class="input-group">
                        <label>ãƒãƒƒãƒãƒ³ã‚°ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="matchingRate" value="70" oninput="calculateForecast()">
                    </div>
                    <button class="btn btn-primary" onclick="calculateForecast()">ğŸ”„ äºˆæ¸¬ã‚’å†è¨ˆç®—</button>
                </div>

                <div>
                    <h3>ğŸ“ˆ äºˆæ¸¬çµæœ</h3>
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <div class="kpi-label">äºˆæ¸¬å£²ä¸Š</div>
                            <div class="kpi-value" id="calculatedSales">Â¥0</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-label">å®Ÿè³ªç¨¼åƒæ•°</div>
                            <div class="kpi-value" id="effectiveWorkDays">0æ—¥</div>
                            <div class="kpi-trend">ãƒãƒƒãƒãƒ³ã‚°å¾Œ</div>
                        </div>
                    </div>
                    <div class="formula-box">
                        <strong>ğŸ’¡ è¨ˆç®—å¼ï¼š</strong><br>
                        äºˆæ¸¬å£²ä¸Š = å¹³å‡å˜ä¾¡ Ã— å»¶ã¹ç¨¼åƒæ—¥æ•° Ã— ãƒãƒƒãƒãƒ³ã‚°ç‡<br><br>
                        <strong>ä¾‹ï¼š</strong><br>
                        Â¥15,000 Ã— 680æ—¥ Ã— 70% = Â¥7,140,000
                    </div>
                </div>
            </div>
        </div>

        <!-- äº‹æ¥­è¨ˆç”» -->
        <div id="tab-plan" class="section">
            <h2>ğŸ¯ äº‹æ¥­è¨ˆç”»ç®¡ç†</h2>
            
            <h3>å¹´é–“ç›®æ¨™è¨­å®š</h3>
            <div class="input-group">
                <label>å¹´é–“ç›®æ¨™å£²ä¸Šï¼ˆå††ï¼‰</label>
                <input type="number" id="annualTarget" value="60000000" oninput="updateMonthlyTarget()">
            </div>
            <div class="input-group">
                <label>æœˆé–“ç›®æ¨™å£²ä¸Šï¼ˆå††ï¼‰</label>
                <input type="number" id="monthlyTarget" value="5000000" readonly>
            </div>
            
            <button class="btn btn-primary" onclick="savePlan()">ğŸ’¾ ä¿å­˜ã™ã‚‹</button>

            <div class="chart-container">
                <h3>ğŸ“Š æœˆåˆ¥ç›®æ¨™é€²æ—ã‚°ãƒ©ãƒ•</h3>
                <canvas id="planChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let planChart = null;

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');

            // åˆå›èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
            if (tabName === 'submission') {
                renderSubmissionTable();
            } else if (tabName === 'plan') {
                renderPlanChart();
            }
        }

        // KPIæ¦‚è¦ã®æ›´æ–°
        function updateKPIOverview() {
            const submissions = JSON.parse(localStorage.getItem('all_availability_submissions') || '[]');
            
            // æå‡ºæ¸ˆã¿ã‚¹ã‚¿ãƒƒãƒ•æ•°
            const uniqueStaff = new Set(submissions.map(s => s.staffId));
            const submittedCount = uniqueStaff.size;
            
            // å»¶ã¹ç¨¼åƒæ—¥æ•°
            const totalDays = submissions.reduce((sum, sub) => sum + sub.dates.length, 0);
            
            document.getElementById('submittedStaff').textContent = submittedCount;
            document.getElementById('availableStaff').textContent = `${submittedCount}äºº`;
            document.getElementById('workingDays').textContent = `${totalDays}æ—¥`;

            // å£²ä¸Šäºˆæ¸¬ã‚’è¨ˆç®—
            const unitPrice = 15000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå˜ä¾¡
            const matchingRate = 0.7; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒƒãƒãƒ³ã‚°ç‡
            const forecastSales = unitPrice * totalDays * matchingRate;
            
            document.getElementById('forecastSales').textContent = `Â¥${Math.round(forecastSales).toLocaleString()}`;
            
            // é”æˆç‡è¨ˆç®—
            const targetSales = 5000000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç›®æ¨™
            const achievementRate = (forecastSales / targetSales * 100).toFixed(1);
            document.getElementById('achievementRate').textContent = `${achievementRate}%`;
        }

        // æå‡ºçŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
        function renderSubmissionTable() {
            const tbody = document.getElementById('submissionTableBody');
            const submissions = JSON.parse(localStorage.getItem('all_availability_submissions') || '[]');
            
            const today = new Date();
            const currentDay = today.getDate();
            const deadline = 15;
            const daysLeft = deadline - currentDay;
            
            document.getElementById('daysUntilDeadline').textContent = `${Math.max(0, daysLeft)}æ—¥`;

            // ã‚¹ã‚¿ãƒƒãƒ•ã®æå‡ºçŠ¶æ³ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿100ååˆ†ã‚’å«ã‚€ï¼‰
            const totalStaff = 100;
            const submittedStaff = submissions.length;
            const pendingStaff = totalStaff - submittedStaff;
            
            document.getElementById('submittedCount').textContent = `${submittedStaff}äºº`;
            document.getElementById('pendingCount').textContent = `${pendingStaff}äºº`;
            document.getElementById('submittedPercentage').textContent = ((submittedStaff / totalStaff) * 100).toFixed(1);
            document.getElementById('pendingPercentage').textContent = ((pendingStaff / totalStaff) * 100).toFixed(1);

            // å¹³å‡ç¨¼åƒæ—¥æ•°
            const totalDays = submissions.reduce((sum, sub) => sum + sub.dates.length, 0);
            const avgDays = submittedStaff > 0 ? (totalDays / submittedStaff).toFixed(1) : 0;
            document.getElementById('avgDays').textContent = `${avgDays}æ—¥`;

            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            const tableData = submissions.map(sub => ({
                code: sub.staffId,
                name: sub.staffName || `ã‚¹ã‚¿ãƒƒãƒ•${sub.staffId}`,
                month: `${sub.year}å¹´${sub.month}æœˆ`,
                days: sub.dates.length,
                date: sub.submittedAt,
                status: 'submitted'
            }));

            // æœªæå‡ºã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆæœ€åˆã®æ•°ä»¶ã®ã¿è¡¨ç¤ºï¼‰
            for (let i = submittedStaff; i < Math.min(submittedStaff + 5, totalStaff); i++) {
                tableData.push({
                    code: String(i + 1).padStart(3, '0'),
                    name: `ã‚¹ã‚¿ãƒƒãƒ•${String(i + 1).padStart(3, '0')}`,
                    month: '2025å¹´12æœˆ',
                    days: 0,
                    date: '-',
                    status: 'pending'
                });
            }

            tbody.innerHTML = tableData.map(item => `
                <tr>
                    <td>${item.code}</td>
                    <td>${item.name}</td>
                    <td>${item.month}</td>
                    <td>${item.days}æ—¥</td>
                    <td>${item.date}</td>
                    <td>
                        <span class="status-badge status-${item.status}">
                            ${item.status === 'submitted' ? 'âœ… æå‡ºæ¸ˆã¿' : 'â³ æœªæå‡º'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // å£²ä¸Šäºˆæ¸¬è¨ˆç®—
        function calculateForecast() {
            const submissions = JSON.parse(localStorage.getItem('all_availability_submissions') || '[]');
            
            const unitPrice = parseInt(document.getElementById('avgUnitPrice').value);
            const totalDays = submissions.reduce((sum, sub) => sum + sub.dates.length, 0);
            const matchingRate = parseInt(document.getElementById('matchingRate').value) / 100;

            const uniqueStaff = new Set(submissions.map(s => s.staffId));
            const staffCount = uniqueStaff.size;

            document.getElementById('availableStaffCount').value = staffCount;
            document.getElementById('totalAvailableDays').value = totalDays;

            const effectiveDays = totalDays * matchingRate;
            const forecastSales = unitPrice * effectiveDays;

            document.getElementById('calculatedSales').textContent = 
                `Â¥${Math.round(forecastSales).toLocaleString()}`;
            document.getElementById('effectiveWorkDays').textContent = 
                `${Math.round(effectiveDays)}æ—¥`;
        }

        // æœˆé–“ç›®æ¨™æ›´æ–°
        function updateMonthlyTarget() {
            const annualTarget = document.getElementById('annualTarget').value;
            const monthlyTarget = Math.round(annualTarget / 12);
            document.getElementById('monthlyTarget').value = monthlyTarget;
        }

        // äº‹æ¥­è¨ˆç”»ä¿å­˜
        function savePlan() {
            const annualTarget = document.getElementById('annualTarget').value;
            const monthlyTarget = document.getElementById('monthlyTarget').value;
            
            localStorage.setItem('businessPlan', JSON.stringify({
                annualTarget: parseInt(annualTarget),
                monthlyTarget: parseInt(monthlyTarget)
            }));
            
            alert('âœ… äº‹æ¥­è¨ˆç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            renderPlanChart();
        }

        // äº‹æ¥­è¨ˆç”»ã‚°ãƒ©ãƒ•æç”»
        function renderPlanChart() {
            const plan = JSON.parse(localStorage.getItem('businessPlan') || '{"monthlyTarget": 5000000}');
            const monthlyTarget = plan.monthlyTarget;

            const ctx = document.getElementById('planChart');
            if (!ctx) return;

            if (planChart) {
                planChart.destroy();
            }

            planChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                    datasets: [{
                        label: 'ç›®æ¨™å£²ä¸Š',
                        data: Array(12).fill(monthlyTarget),
                        backgroundColor: 'rgba(26, 58, 82, 0.5)',
                        borderColor: 'rgba(26, 58, 82, 1)',
                        borderWidth: 2
                    }, {
                        label: 'å®Ÿç¸¾',
                        data: [4800000, 5200000, 4900000, 5100000, 0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(0, 160, 176, 0.5)',
                        borderColor: 'rgba(0, 160, 176, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // åˆæœŸåŒ–
        function init() {
            updateKPIOverview();
            calculateForecast();
            
            // äº‹æ¥­è¨ˆç”»èª­ã¿è¾¼ã¿
            const plan = JSON.parse(localStorage.getItem('businessPlan') || '{"annualTarget": 60000000}');
            if (plan.annualTarget) {
                document.getElementById('annualTarget').value = plan.annualTarget;
                updateMonthlyTarget();
            }
        }

        init();
    </script>
</body>
</html>

